@page "/tasks"
@rendermode InteractiveServer
@attribute [StreamRendering]

<PageTitle>Tasks</PageTitle>

<h1>Task Overview</h1>



@if (!string.IsNullOrWhiteSpace(_errorMessage))
{
    <div class="alert alert-danger mt-3">@_errorMessage</div>
}


@if (_showCreateModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,.5);" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Task</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="HideCreateModal"></button>
                </div>

                <EditForm Model="_taskForm" FormName="create-task" OnValidSubmit="CreateTaskAsync"
                    OnInvalidSubmit="HandleInvalidSubmit">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <input @bind-Value="_taskForm.Title" @bind-Value:event="oninput" class="form-control"
                            placeholder="Task title" />
                        <input @bind-Value="_taskForm.Description" @bind-Value:event="oninput" class="form-control"
                            placeholder="Task description" />
                        <ValidationSummary />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" @onclick="HideCreateModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@_isSubmitting">Create</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}



@if (_projects is null)
{
    <p class="mt-4"><em>Loading...</em></p>
}
else if (_projects.Count == 0)
{
    <p class="mt-4"><em>No projects yet—create your first one <a href="projects">here</a>.</em></p>
}
else
{
    <div class="row align-items-center g-3 mb-4">
        <div class="col-12 col-md-6">
            <select class="form-select" @bind="SelectedProjectId">
                <option value="">Select a project…</option>
                @foreach (var project in _projects)
                {
                    <option value="@project.Id">@project.Title</option>
                }
            </select>
        </div>
        <div class="col-12 col-md-6">
            <p class="mt-4"><em>Not seeing a fitting project? Create one <a href="projects">here</a>.</em></p>
        </div>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th class="text-end">Actions</th>
            </tr>
        </thead>
        @if (_isLoadingTasks)
        {
            <p><em>Loading tasks...</em></p>
            <p> "@_tasks"</p>
        }
        else if (_tasks is null)
        {
            <p><em>Please select a project to view its tasks.</em></p>
        }
        else
        {
            <tbody>
                @foreach (var task in _tasks)
                {
                    <tr>
                        <td>@task.Title</td>
                        <td>@task.Description</td>
                        <td class="text-end">
                            <button class="btn btn-danger btn-sm" title="Delete" disabled="@_isSubmitting"
                                @onclick="() => DeleteTaskAsync(task)">
                                <i class="fa-solid fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        }
    </table>
}

<button class="btn btn-primary" @onclick="ShowCreateModal"> Create New Task</button>
